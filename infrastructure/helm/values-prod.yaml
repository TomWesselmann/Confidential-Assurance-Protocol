# Production Environment Values

replicaCount: 3

image:
  tag: "0.11.0"
  pullPolicy: IfNotPresent

resources:
  limits:
    cpu: 2000m
    memory: 1Gi
  requests:
    cpu: 500m
    memory: 512Mi

autoscaling:
  enabled: true
  minReplicas: 3
  maxReplicas: 20
  targetCPUUtilizationPercentage: 75
  targetMemoryUtilizationPercentage: 80

ingress:
  enabled: true
  className: "nginx"
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    nginx.ingress.kubernetes.io/ssl-protocols: "TLSv1.2 TLSv1.3"
    nginx.ingress.kubernetes.io/ssl-ciphers: "HIGH:!aNULL:!MD5"
    nginx.ingress.kubernetes.io/rate-limit: "100"
  hosts:
    - host: cap-verifier.example.com
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: cap-verifier-prod-tls
      hosts:
        - cap-verifier.example.com

podAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/port: "8080"
  prometheus.io/path: "/metrics"
  vault.hashicorp.com/agent-inject: "true"
  vault.hashicorp.com/role: "cap-verifier"

features:
  allow_embedded_ir: false  # Require policy_id in production
  require_mtls: true
  enable_prometheus_metrics: true
  # Week 6: Adaptive Enforcement (progressive rollout)
  enforce_enabled: false  # Start with dry-run/shadow mode
  enforce_rollout_percent: 0  # 0% = shadow only, 25/50/100 = progressive enforcement
  drift_max_ratio: 0.005  # Max 0.5% drift before alerting

oauth2:
  enabled: true
  issuer: "https://idp.example.com"
  audience: "cap-verifier-prod"
  jwks_url: "https://idp.example.com/.well-known/jwks.json"
  jwks_cache_ttl_sec: 600

tls:
  enabled: true
  require_mtls: true
  tls_min_version: "1.3"
  cipher_profile: "modern"

rateLimit:
  enabled: true
  requests_per_minute: 60
  burst: 100

cache:
  enabled: true
  size: 5000  # Larger cache in production
  ttl_seconds: 7200

env:
  - name: RUST_LOG
    value: "info,cap_agent=info"
  - name: RUST_BACKTRACE
    value: "0"
  - name: ENVIRONMENT
    value: "production"

# Production-specific affinity
affinity:
  podAntiAffinity:
    requiredDuringSchedulingIgnoredDuringExecution:
      - labelSelector:
          matchExpressions:
            - key: app.kubernetes.io/name
              operator: In
              values:
                - cap-verifier
        topologyKey: kubernetes.io/hostname
  nodeAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        preference:
          matchExpressions:
            - key: node.kubernetes.io/instance-type
              operator: In
              values:
                - m5.xlarge
                - m5.2xlarge

# Production tolerations for dedicated nodes
tolerations:
  - key: "workload"
    operator: "Equal"
    value: "cap-verifier"
    effect: "NoSchedule"
