version: '3.8'

services:
  # ============================================================================
  # CAP Verifier API - REST API Server
  # ============================================================================
  cap-api:
    build:
      context: .
      dockerfile: Dockerfile
    image: cap-agent:0.11.0
    container_name: cap-verifier-api
    restart: unless-stopped

    # Ports
    ports:
      - "8080:8080"  # HTTP API
      # - "8443:8443"  # HTTPS API (uncomment when TLS configured)

    # Environment variables
    environment:
      - RUST_LOG=info,cap_agent=debug
      - RUST_BACKTRACE=1
      - CAP_BIND_ADDRESS=0.0.0.0:8080
      - CAP_REGISTRY_PATH=/app/build/registry.sqlite
      - CAP_BLOB_STORE_PATH=/app/build/test_blobs.sqlite
      - CAP_KEYS_DIR=/app/keys
      - CAP_AUDIT_LOG=/app/build/audit_chain.jsonl

    # Volumes
    volumes:
      # Persistent data
      - cap-registry:/app/build
      - cap-keys:/app/keys
      # Config (read-only)
      - ./config:/app/config:ro
      # Examples (read-only)
      - ./examples:/app/examples:ro

    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/healthz"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

    # Networking
    networks:
      - cap-network

    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================================
  # CAP CLI - Command-line interface (for manual operations)
  # ============================================================================
  cap-cli:
    image: cap-agent:0.11.0
    container_name: cap-agent-cli
    entrypoint: ["/usr/local/bin/cap-agent"]
    command: ["--help"]

    # Environment
    environment:
      - RUST_LOG=info,cap_agent=debug

    # Volumes (shared with API)
    volumes:
      - cap-registry:/app/build
      - cap-keys:/app/keys
      - ./config:/app/config:ro
      - ./examples:/app/examples:ro

    # Networking
    networks:
      - cap-network

    # Lifecycle
    profiles:
      - cli  # Only start when explicitly requested

# ============================================================================
# Volumes - Persistent storage
# ============================================================================
volumes:
  cap-registry:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./build

  cap-keys:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./keys

# ============================================================================
# Networks
# ============================================================================
networks:
  cap-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

# ============================================================================
# Example Usage:
# ============================================================================
# Start API:
#   docker-compose up -d cap-api
#
# View logs:
#   docker-compose logs -f cap-api
#
# Run CLI command:
#   docker-compose run --rm cap-cli version
#
# Run CLI with specific command:
#   docker-compose run --rm cap-cli audit verify --file /app/build/audit_chain.jsonl
#
# Stop all:
#   docker-compose down
#
# Rebuild:
#   docker-compose build --no-cache
# ============================================================================
