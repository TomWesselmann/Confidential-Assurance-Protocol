name: Security Audit

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run security audit every Monday at 9:00 UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  security-audit:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          components: rustfmt, clippy

      - name: Cache cargo registry
        uses: actions/cache@v3
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v3
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v3
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Install cargo-audit
        run: cargo install cargo-audit --locked

      - name: Run cargo audit
        id: audit
        run: |
          mkdir -p build
          cargo audit --json > build/audit-report.json || true
          echo "Audit report generated at build/audit-report.json"

          # Check if there are any vulnerabilities
          if cargo audit --deny warnings; then
            echo "result=success" >> $GITHUB_OUTPUT
          else
            echo "result=failure" >> $GITHUB_OUTPUT
          fi

      - name: Upload audit report
        uses: actions/upload-artifact@v3
        with:
          name: security-audit-report
          path: build/audit-report.json
          retention-days: 90

      - name: Fail on vulnerabilities
        if: steps.audit.outputs.result == 'failure'
        run: |
          echo "::error::Security vulnerabilities detected. See audit report for details."
          exit 1

  sbom-generation:
    name: Generate SBOM
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Cache cargo registry
        uses: actions/cache@v3
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Install cargo-cyclonedx
        run: cargo install cargo-cyclonedx --locked

      - name: Generate SBOM
        run: |
          mkdir -p build
          cargo cyclonedx --format json --spec-version 1.4 --all-features
          # cargo-cyclonedx outputs to current directory by default
          mv cap_agent.cdx.json build/sbom.json || echo "SBOM generation may have failed"

      - name: Generate License Report
        run: |
          cargo tree --format "{p} ({l})" | sort -u > build/licenses.txt

      - name: Upload SBOM
        uses: actions/upload-artifact@v3
        with:
          name: sbom
          path: |
            build/sbom.json
            build/licenses.txt
          retention-days: 90

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v3
        with:
          fail-on-severity: moderate
          allow-licenses: MIT, Apache-2.0, BSD-3-Clause, BSD-2-Clause, ISC, Unlicense

  license-check:
    name: License Compliance Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-deny
        run: cargo install cargo-deny --locked

      - name: Check licenses
        run: |
          # Create deny.toml if it doesn't exist
          if [ ! -f deny.toml ]; then
            cat > deny.toml << 'EOF'
          [licenses]
          allow = [
              "MIT",
              "Apache-2.0",
              "BSD-3-Clause",
              "BSD-2-Clause",
              "ISC",
              "Unlicense",
              "0BSD",
          ]
          confidence-threshold = 0.8

          [bans]
          multiple-versions = "warn"
          wildcards = "allow"

          [sources]
          unknown-registry = "warn"
          unknown-git = "warn"
          EOF
          fi

          cargo deny check licenses

  clippy-security:
    name: Clippy Security Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Cache cargo build
        uses: actions/cache@v3
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-clippy-${{ hashFiles('**/Cargo.lock') }}

      - name: Run Clippy with security checks
        run: |
          cargo clippy --all-targets --all-features -- \
            -W clippy::cargo \
            -W clippy::nursery \
            -W clippy::pedantic \
            -A clippy::module-name-repetitions

  summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [security-audit, sbom-generation, license-check, clippy-security]
    if: always()

    steps:
      - name: Generate Summary
        run: |
          echo "# Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Security Audit | ${{ needs.security-audit.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SBOM Generation | ${{ needs.sbom-generation.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| License Check | ${{ needs.license-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Clippy Security | ${{ needs.clippy-security.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow completed at:** $(date -u)" >> $GITHUB_STEP_SUMMARY
