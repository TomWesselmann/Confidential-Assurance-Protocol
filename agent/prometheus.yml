# Prometheus Configuration for CAP Verifier API
#
# This configuration scrapes metrics from the CAP Verifier API
# on port 8080 (HTTP) every 15 seconds.
#
# Usage:
#   1. Copy this file to your Prometheus configuration directory
#   2. Update the targets if running on different host/port
#   3. Restart Prometheus or reload config: kill -HUP <prometheus-pid>

global:
  scrape_interval: 15s      # Scrape targets every 15 seconds
  evaluation_interval: 15s  # Evaluate rules every 15 seconds

  # Attach these labels to any time series or alerts when communicating with
  # external systems (federation, remote storage, Alertmanager).
  external_labels:
    environment: 'production'
    service: 'cap-verifier-api'

# Alertmanager configuration (optional)
alerting:
  alertmanagers:
    - static_configs:
        - targets:
          # - alertmanager:9093

# Load rules once and periodically evaluate them according to the global 'evaluation_interval'.
rule_files:
  # - "alerts.yml"

# Scrape configurations
scrape_configs:
  # CAP Verifier API Metrics
  - job_name: 'cap-verifier-api'

    # Override global scrape_interval for this job
    scrape_interval: 15s
    scrape_timeout: 10s

    # Metrics path (default: /metrics)
    metrics_path: '/metrics'

    # Scheme (http or https)
    scheme: http

    # Static targets
    static_configs:
      - targets:
          - 'localhost:8080'        # Local development
          # - 'cap-api:8080'        # Docker Compose service name
          # - '10.0.1.5:8080'       # Production IP

        # Optional: Add custom labels to all metrics from this target
        labels:
          instance: 'cap-verifier-api-01'
          datacenter: 'dc1'

  # Optional: Kubernetes Service Discovery
  # Uncomment if running in Kubernetes
  # - job_name: 'cap-verifier-api-k8s'
  #   kubernetes_sd_configs:
  #     - role: pod
  #       namespaces:
  #         names:
  #           - lksg-agent
  #   relabel_configs:
  #     - source_labels: [__meta_kubernetes_pod_label_app]
  #       action: keep
  #       regex: cap-verifier-api
  #     - source_labels: [__meta_kubernetes_pod_name]
  #       target_label: pod
  #     - source_labels: [__meta_kubernetes_namespace]
  #       target_label: namespace

# Example Alerting Rules (save as alerts.yml)
# groups:
#   - name: cap_verifier_alerts
#     interval: 30s
#     rules:
#       - alert: HighAuthFailureRate
#         expr: rate(cap_auth_token_validation_failures_total[5m]) > 10
#         for: 5m
#         labels:
#           severity: warning
#         annotations:
#           summary: "High authentication failure rate"
#           description: "Authentication failures exceeded 10/sec for 5 minutes"
#
#       - alert: HighRequestFailureRate
#         expr: (rate(cap_verifier_requests_total{result="fail"}[5m]) / rate(cap_verifier_requests_total[5m])) > 0.1
#         for: 5m
#         labels:
#           severity: critical
#         annotations:
#           summary: "High request failure rate"
#           description: "More than 10% of requests are failing"
#
#       - alert: HighLatency
#         expr: histogram_quantile(0.95, sum(rate(cap_verifier_request_duration_seconds_bucket[5m])) by (le)) > 1
#         for: 5m
#         labels:
#           severity: warning
#         annotations:
#           summary: "High request latency"
#           description: "95th percentile latency exceeded 1 second"
#
#       - alert: LowCacheHitRatio
#         expr: cap_cache_hit_ratio < 0.5
#         for: 10m
#         labels:
#           severity: warning
#         annotations:
#           summary: "Low cache hit ratio"
#           description: "Cache hit ratio below 50% for 10 minutes"
